{"version":3,"file":"index-legacy.90f70e15.js","sources":["../../src/components/code-editor/prismjs.vue","../../src/components/props-to-refs.ts","../../src/components/code-editor/RunKit.vue","../../src/components/run-code.vue","../../src/App.vue","../../src/util/use-url-params-obj.ts","../../src/main.ts"],"sourcesContent":["<template>\r\n  <pre><code ref=\"code\" class=\"language-javascript\">{{props.source}}</code></pre>\r\n</template>\r\n<script lang=\"ts\" setup>\r\nimport { nextTick, onMounted, ref, watchEffect } from \"vue\";\r\nimport Prism from \"prismjs\";\r\nconst props = defineProps({\r\n  source: {\r\n    type: String,\r\n    default: \"\",\r\n  },\r\n});\r\nconst code = ref<HTMLElement | null>(null);\r\nonMounted(() => {\r\n  watchEffect(() => {\r\n    nextTick(() => {\r\n      Prism.highlightElement(code.value! as HTMLElement);\r\n    });\r\n    // 依赖\r\n    return props.source;\r\n  });\r\n});\r\n</script>\r\n<!-- 这个style 加上 scoped 后高亮就失效了 -->\r\n<style src=\"prismjs/themes/prism.css\"></style>\r\n","import type { ToRefs } from \"vue\";\r\nimport { computed } from \"vue\";\r\nexport function propsToRefs<T extends object>(props: T, emit: (event: any, ...args: any[]) => void): ToRefs<T> {\r\n  const ret: any = {};\r\n  for (const key in props) {\r\n    // ret[key] = toRef(props, key);\r\n    ret[key] = computed({\r\n      get() {\r\n        return props[key];\r\n      },\r\n      set(v) {\r\n        emit(`update:${key}`, v);\r\n      },\r\n    });\r\n  }\r\n  return ret;\r\n}\r\n","<template>\r\n  <pre class=\"embed\" :data-gutter=\"inside\"><div ref=\"element\"></div></pre>\r\n</template>\r\n<script lang=\"ts\" setup>\r\nimport { ref, onMounted, watchEffect, computed } from \"vue\";\r\nimport type { PropType } from \"vue\";\r\nimport { propsToRefs } from \"../props-to-refs\";\r\nconst props = defineProps({\r\n  inside: {\r\n    type: String as PropType<EmbedOptions[\"gutterStyle\"]>,\r\n    default: \"inside\",\r\n    required: true,\r\n  },\r\n  source: {\r\n    type: String,\r\n    default: \"\",\r\n  },\r\n  title: {\r\n    type: String,\r\n    default: \"\",\r\n  },\r\n  preamble: {\r\n    type: String,\r\n    default: \"\",\r\n  },\r\n  version: {\r\n    type: String,\r\n    default: \"16.6.0\",\r\n  },\r\n});\r\nconst emit = defineEmits([\r\n  \"update:inside\",\r\n  \"update:source\",\r\n  \"update:title\",\r\n  \"update:preamble\",\r\n  \"update:version\",\r\n  //\r\n  \"update:loading\",\r\n]);\r\nconst { inside, source, title, preamble, version } = propsToRefs(props, emit);\r\nconst element = ref<HTMLElement | null>(null);\r\nconst nodeVersion = computed({\r\n  get() {\r\n    //   run-kit 的 setNodeVersion 似乎只接受这种形式的输入\r\n    return version!\r\n      .value!.trim()\r\n      .split(\".\")\r\n      .map((v, index) => {\r\n        if (index === 0) {\r\n          return v;\r\n        } else {\r\n          return \"x\";\r\n        }\r\n      })\r\n      .join(\".\");\r\n  },\r\n  set(v: string) {\r\n    version!.value = v;\r\n  },\r\n});\r\n/** 在其他编辑组件未加载完毕的时候使用默认组件 */\r\nemit(\"update:loading\", true);\r\nonMounted(async () => {\r\n  const cell = window.RunKit.createNotebook({\r\n    element: element.value! as HTMLElement,\r\n    preamble: preamble!.value,\r\n    title: title!.value,\r\n    gutterStyle: inside.value,\r\n    source: source!.value,\r\n    nodeVersion: nodeVersion.value,\r\n  });\r\n  cell.onLoad = async (_book) => {\r\n    emit(\"update:loading\", false);\r\n    cell.evaluate();\r\n  };\r\n\r\n  // 各种属性的绑定\r\n  cell.onSave = async () => {\r\n    cell.getSource().then((v) => (source!.value = v));\r\n    cell.getNodeVersion().then((v) => (nodeVersion.value = v));\r\n  };\r\n  watchEffect(() => cell.setSource(source!.value!));\r\n  watchEffect(() => cell.setTitle(title!.value!));\r\n  watchEffect(() => cell.setPreamble(preamble!.value!));\r\n  watchEffect(() => cell.setNodeVersion(nodeVersion.value));\r\n});\r\n</script>\r\n","<template>\r\n  <PrismJs v-if=\"loading\" :source=\"source\"></PrismJs>\r\n  <RunKit\r\n    v-model:source=\"source\"\r\n    v-model:inside=\"inside\"\r\n    v-model:title=\"title\"\r\n    v-model:preamble=\"preamble\"\r\n    v-model:version=\"version\"\r\n    @update:loading=\"(b) => (loading = b)\"\r\n  ></RunKit>\r\n</template>\r\n\r\n<script lang=\"ts\" setup>\r\nimport type { PropType } from \"vue\";\r\nimport { ref } from \"vue\";\r\nimport PrismJs from \"./code-editor/prismjs.vue\";\r\nimport RunKit from \"./code-editor/RunKit.vue\";\r\nimport { propsToRefs } from \"./props-to-refs\";\r\nconst props = defineProps({\r\n  inside: {\r\n    type: String as PropType<EmbedOptions[\"gutterStyle\"]>,\r\n    default: \"inside\",\r\n    required: true,\r\n  },\r\n  source: {\r\n    type: String,\r\n    default: \"\",\r\n  },\r\n  title: {\r\n    type: String,\r\n    default: \"\",\r\n  },\r\n  preamble: {\r\n    type: String,\r\n    default: \"\",\r\n  },\r\n  version: {\r\n    type: String,\r\n    default: \"16.6.0\",\r\n  },\r\n});\r\nconst emit = defineEmits([\r\n  \"update:inside\",\r\n  \"update:source\",\r\n  \"update:title\",\r\n  \"update:preamble\",\r\n  \"update:version\",\r\n]);\r\nconst { inside, source, title, preamble, version } = propsToRefs(props, emit);\r\n\r\n/** 在其他编辑组件加载完毕后隐藏默认组件 */\r\nconst loading = ref(true);\r\n</script>\r\n","<template>\n  <RunCodeVue\n    v-model:source=\"config.source\"\n    v-model:inside=\"config.inside\"\n    v-model:title=\"config.title\"\n    v-model:preamble=\"config.preamble\"\n    v-model:version=\"config.version\"\n  />\n</template>\n\n<script lang=\"ts\" setup>\nimport RunCodeVue from \"./components/run-code.vue\";\nimport { reactive, onBeforeMount, watchEffect } from \"vue\";\n\nimport { api, util, config as apiConfig } from \"siyuan_api_cache_lib\";\nimport { useParamsObj } from \"./util/use-url-params-obj\";\nimport LZString from \"lz-string\";\n\n// 非开发模式下不用设定 server，使用相对路径来指向 思源server\nif (import.meta.env.DEV) {\n  apiConfig.server = \"http://127.0.0.1:6806\";\n}\n\napiConfig.apiCache = true;\nconst config = reactive({\n  source: \"\",\n  inside: \"inside\" as const,\n  title: \"\",\n  preamble: \"\",\n  version: \"16.6.0\",\n});\n\nonBeforeMount(async () => {\n  const id = util.currentNodeId();\n  // 从 url 获取 config，以及将 config 保存至 url\n  const [AppOptions, href] = useParamsObj(undefined, { code: \"{}\" });\n  watchEffect(() => history.replaceState(\"\", \"\", href.value));\n\n  Object.assign(\n    config,\n    JSON.parse(LZString.decompressFromBase64(AppOptions.code) || \"{}\")\n  );\n  watchEffect(() => {\n    AppOptions.code = LZString.compressToBase64(JSON.stringify(config));\n  });\n\n  // 从本地获取 config 的值\n  if (id) {\n    api\n      .getBlockAttr(id, \"custom-config\")\n      .then((r) => {\n        if (r) {\n          const source = util.htmlDecode(r.value);\n          if (source) {\n            Object.assign(config, JSON.parse(source));\n          } else {\n            console.error(\"decode 失败, code:\", r.value);\n          }\n        }\n        // 没有找到配置项，啥也不做\n      })\n      .catch((e) => {\n        console.error(\"查询config失败\", e);\n      });\n    // 保存 config 到本地\n    if (util.getCurrentEnv() === util.getCurrentEnv.env.siYuan) {\n      watchEffect(() => {\n        api\n          .setBlockAttrs({\n            id: util.currentNodeId()!,\n            attrs: { \"custom-config\": JSON.stringify(config) },\n          })\n          .then((r) => {\n            // console.log(\"保存成功\", r);\n          });\n      });\n    }\n  } else {\n    console.error(\"获取当前挂件快id失败，不再尝试调用思源 api 保存代码\");\n  }\n});\n</script>\n","import { reactive, computed } from \"vue\";\r\n\r\n/** 返回一个 params对象 与 href 字符串computed ,href 依赖于 params\r\n * @example\r\n * ```js\r\n *   const [AppOptions, href] = useParamsObj(undefined, {});\r\n *   // 将基于 AppOptions 计算得来的 href 设置到 history\r\n *   watchEffect(() => history.replaceState(\"\", \"\", href.value));\r\n * ```\r\n */\r\nexport function useParamsObj<T extends object>(\r\n  urlStr = document.location.toString(),\r\n  defaultParams: T\r\n) {\r\n  const url = new URL(urlStr);\r\n  const searchParams = url.searchParams;\r\n\r\n  const params = reactive(defaultParams);\r\n\r\n  searchParams.forEach((v, k) => {\r\n    try {\r\n      (params as any)[k] = atob(v);\r\n    } catch (error) {\r\n      // 兼容直接输入的情况\r\n      (params as any)[k] = v;\r\n    }\r\n  });\r\n\r\n  const href = computed(() => {\r\n    Object.keys(params).forEach((k) => {\r\n      const v = btoa((params as any)[k] || \"\");\r\n      searchParams.set(k, v);\r\n    });\r\n    return url.href;\r\n  });\r\n  return [params, href] as const;\r\n}","import { createApp } from 'vue'\nimport App from './App.vue'\n\nconst app = createApp(App)\napp.mount('#app')\napp.config\n\n\n"],"names":["code","ref","highlightElement","value","props","source","emit","ret","key","computed","get","set","v","inside","title","preamble","version","propsToRefs","element","nodeVersion","trim","split","map","index","join","async","cell","window","RunKit","createNotebook","gutterStyle","onLoad","evaluate","onSave","getSource","then","getNodeVersion","setSource","setTitle","setPreamble","setNodeVersion","loading","apiCache","config","reactive","id","util.currentNodeId","AppOptions","href","urlStr","document","location","toString","defaultParams","url","URL","searchParams","params","forEach","k","atob","error","keys","btoa","useParamsObj","history","replaceState","assign","JSON","parse","LZString","decompressFromBase64","compressToBase64","stringify","getBlockAttr","r","util.htmlDecode","catch","e","util.getCurrentEnv","env","siYuan","setBlockAttrs","attrs","app","createApp","App","mount"],"mappings":"6uEAYMA,EAAOC,EAAwB,gBAC3B,QACI,QACD,OACDC,iBAAiBF,EAAKG,UAGvBC,EAAMC,sHCjB6BD,EAAUE,SAChDC,EAAW,aACNC,KAAOJ,IAEZI,GAAOC,EAAS,CAClBC,QACSN,EAAMI,GAEfG,IAAIC,eACaJ,IAAOI,aAIrBL,6WCwBHM,OAAEA,EAAFR,OAAUA,EAAVS,MAAkBA,EAAlBC,SAAyBA,EAAzBC,QAAmCA,GAAYC,EAAYb,EAAOE,GAClEY,EAAUjB,EAAwB,MAClCkB,EAAcV,EAAS,CAC3BC,QAESM,EACJb,MAAOiB,OACPC,MAAM,KACNC,KAAI,CAACV,EAAGW,IACO,IAAVA,EACKX,EAEA,MAGVY,KAAK,KAEVb,IAAIC,KACOT,MAAQS,cAIhB,kBAAkB,MACba,gBACFC,EAAOC,OAAOC,OAAOC,eAAe,CACxCX,QAASA,EAAQf,MACjBY,SAAUA,EAAUZ,MACpBW,MAAOA,EAAOX,MACd2B,YAAajB,EAAOV,MACpBE,OAAQA,EAAQF,MAChBgB,YAAaA,EAAYhB,UAEtB4B,OAASN,MAAAA,MACP,kBAAkB,KAClBO,cAIFC,OAASR,YACPS,YAAYC,MAAMvB,GAAOP,EAAQF,MAAQS,MACzCwB,iBAAiBD,MAAMvB,GAAOO,EAAYhB,MAAQS,QAE7C,IAAMc,EAAKW,UAAUhC,EAAQF,YAC7B,IAAMuB,EAAKY,SAASxB,EAAOX,YAC3B,IAAMuB,EAAKa,YAAYxB,EAAUZ,YACjC,IAAMuB,EAAKc,eAAerB,EAAYhB,saCpC9CU,OAAEA,EAAFR,OAAUA,EAAVS,MAAkBA,EAAlBC,SAAyBA,EAAzBC,QAAmCA,GAAYC,EAAYb,EAAOE,GAGlEmC,EAAUxC,GAAI,wjBC5BVyC,UAAW,QACfC,EAASC,EAAS,CACtBvC,OAAQ,GACRQ,OAAQ,SACRC,MAAO,GACPC,SAAU,GACVC,QAAS,qBAGGS,gBACNoB,EAAKC,KAEJC,EAAYC,YCxBnBC,EAASC,SAASC,SAASC,WAC3BC,SAEMC,EAAM,IAAIC,IAAIN,GACdO,EAAeF,EAAIE,aAEnBC,EAASb,EAASS,KAEXK,SAAQ,CAAC9C,EAAG+C,SAEpBF,EAAeE,GAAKC,KAAKhD,SACnBiD,GAENJ,EAAeE,GAAK/C,YAInBoC,EAAOvC,GAAS,YACbqD,KAAKL,GAAQC,SAASC,UACrB/C,EAAImD,KAAMN,EAAeE,IAAM,MACxBhD,IAAIgD,EAAG/C,MAEf0C,EAAIN,cAEN,CAACS,EAAQT,GDAWgB,MAAa,EAAW,CAAEhE,KAAM,UAC/C,IAAMiE,QAAQC,aAAa,GAAI,GAAIlB,EAAK7C,gBAE7CgE,OACLxB,EACAyB,KAAKC,MAAMC,EAASC,qBAAqBxB,EAAW/C,OAAS,UAEnD,OACCA,KAAOsE,EAASE,iBAAiBJ,KAAKK,UAAU9B,OAIzDE,KAEC6B,aAAa7B,EAAI,iBACjBV,MAAMwC,OACDA,EAAG,OACCtE,EAASuE,EAAgBD,EAAExE,OAC7BE,SACK8D,OAAOxB,EAAQyB,KAAKC,MAAMhE,YAEzBwD,MAAM,mBAAoBc,EAAExE,WAKzC0E,OAAOC,YACEjB,MAAM,aAAciB,MAG5BC,MAAyBA,EAAmBC,IAAIC,WACtC,OAEPC,cAAc,CACbrC,GAAIC,IACJqC,MAAO,CAAE,gBAAiBf,KAAKK,UAAU9B,MAE1CR,MAAMwC,oBAMLd,MAAM,0cE3ElB,MAAMuB,EAAMC,EAAUC,GACtBF,EAAIG,MAAM,QACVH,EAAIzC"}